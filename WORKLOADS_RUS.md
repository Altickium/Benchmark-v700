# Тестирование на новых рабочих нагрузках

## Запуск бенчмарка

```
cd setbench/microbench

LD_PRELOAD=../lib/libjemalloc.so ./bin/<data_structure_name>.debra <thread_loop_type> <keygen_type> <parameters>
```

Пример:
```
LD_PRELOAD=../lib/libjemalloc.so ./bin/aksenov_splaylist_64.debra -skewed-sets 
    -rp 0.9 -rs 0.1 -wp 0.9 -ws 0.2 -inter 0.05 -i 0.05 -d 0.05 -rq 0 -k 100000 
    -prefillsize 100000 -nprefill 8 -t 10000 -nrq 0 -nwork 8 -prefill-insert 
```

Если после запуска что-то ломается, или возникает такая проблема:
```
PAPI ERROR: thread 0 unable to add event PAPI_L2_DCM: Permission level does not permit operation
```
, то может помочь следующее:
```
sudo sysctl kernel.perf_event_paranoid=1
```

## Виды ThreadLoops

### Default

Default ThreadLoop имеет одно и то же соотношений типов операций на всё тестирование.
Для его вызова, аргумент `thread_loop_type` необходимо оставить пустым.

### Temporary Operation ThreadLoop

Аргумент для вызова — `-temporary-operation` или `-temp-oper`

Temporary Operation ThreadLoop выбирает следующий тип операцию в зависимости от временного интервала.

## Виды Генераторов ключей

### Стандартная

Стандартная рабочая нагрузка, где есть лишь одно распределение ключей на все виды операций.
Для его вызова, аргумент `keygen_type` необходимо оставить пустым.

### Skewed sets

Аргумент для вызова — `-skewed-sets`

Для запросов чтения и записи используются разные распределения.

Примечания:
+ Во время предварительного заполнения, сначала заполняется множество горячего чтения, а после все остальное с равномерным распределением.
  Для классического заполнения, где ключи для вставки и удаления генерируются так же, как и при обычной работе, нужно дописать параметр `-write-prefill-only`.
+ На данном этапе реализации используются только `skewed-uniform` распределения

[//]: # (При использовании скошенных распределений, )
[//]: # (для контролирования пересечения "горячих" данных для операций чтения и записи )

### Temporary skewed

Аргумент для вызова — `-temporary-skewed` или `-temp-skewed`

На каждый временной промежуток своё распределение ключей.
Есть два типа временных промежутка:
1. Горячее время — когда элементы из какого-то подмножество
   вызывается чаще остальных
2. Время отдыха — когда элементы вызываются равновероятно

Примечание:
+ На данном этапе реализации используются только `skewed-uniform` распределения

### Сreakers and wave

Аргумент для вызова — `-creakers-and-wave`

Есть два типа данных: старички и волна.  
Старички (creakers) — данные, которые запрашиваются редко, но на постоянной основе.  
Волна (wave) — данные, где новые элементы запрашиваются очень часто,
но со временем их востребованность падает, после чего и вовсе удаляются.

Примечание:
+ Параметр `-prefillsize` игнорируется. В структуру заполняются старички и первая волна.
+ В случае, если данные удаляются сначала логически и со временем физически,
  тестирующий должен подобрать значение количества ключей `N` так,
  чтобы элемент был гарантировано удалён физически за `N` запросов.
  Иначе велика вероятность, что данные из `wave` станут теми же старичками,
  и суть рабочей нагрузки пропадёт.



## Параметры

### Обозначения

+ `<p>` — целое число принимающее значение [0, 100]
+ `<n>` — целое число принимающее значение [0, +∞]
+ `<f>` — дробное число принимающее значение [0, 1]
+ `<d>` — дробное число принимающее значение [0, +∞]

[//]: # (+ `<p>` —)

[//]: # ($+\infty$+∞)


### Общие параметры

+ `-k <n>` — количество ключей
+ `-nrq <n>` — количество потоков выполняющие только запросы вида `range_query`
+ `-nwork <n>` — количество потоков
+ `-nprefill <n>` — количество выделенных потоков для предварительного заполнения
+ `-prefill-insert` — заполнение контейнера посредством операций insert
+ `-prefill-mixed` —
+ `-prefill-hybrid-min-ms <>` —
+ `-prefill-hybrid-max-ms <>` —
+ `-prefillsize <n>` — количество ключей для заполнения
+ `-t <n>` — время работы бенчамрка в миллисекундах
+ `-non-shuffle` — включение режима без перемешивания ключей
+ `-pin <....>` —

### ThreadLoops

#### Default ThreadLoop 

+ `-i <f>` — процентное соотношение операций `insert`
+ `-d <f>` — процентное соотношение операций `delete`
+ `-insdel <f1> <f2>` — процентное соотношение операций `insert` и `delete`.
  Равносильно `-i <f1> -d <f2>`
+ `-rq <f>` — процентное соотношение операций `range_query`

#### Temporary Operation ThreadLoop

+ `-temp-oper-count <n>` — количество временных интервалов
+ `-ot <n1> <n2>` — длительность `n1`-ого интервала
+ `-i <n> <f>` — процентное соотношение операций `insert` на `n`-ом интервале
+ `-d <n> <f>` — процентное соотношение операций `delete` на `n`-ом интервале
+ `-insdel <n> <f1> <f2>` — процентное соотношение операций `insert` и `delete` на `n`-ом интервале.
  Равносильно `-i <n> <f1> -d <n> <f2>`
+ `-rq <n> <f>` — процентное соотношение операций `range_query` на <n>-ом интервале

### Key Generators

#### Стандартный генератор ключей

+ `<dist_type>` — распределение, которое будет использоваться в стандартной рабочей нагрузке.

#### Skewed sets

+ `-rs <f>` — размер "горячих" данных для чтения в соотношении ко всему множеству ключей
+ `-ws <f>` — аналогично для операции записи
+ `-rp <f>` — вероятность чтения "горячих" данных
+ `-wp <f>` — аналогично для операции записи
+ `-inter <f>` — размер пересечения "горячих" данных для чтения и записи
  в соотношении ко всему множеству ключей. Важное условие: `inter <= rs` и `inter <= ws`
+ `-write-prefill-only` — меняет тип генерации ключей для предварительного заполнения.

#### Temporary skewed

+ `-set-count <n>` — количество подмножеств / распределений, зависимых от времени
+ `-ht <h>` — горячее время по умолчанию (указывается в количествах итераций):
  если горячее время после определенного временного промежутка не будет явно указано,
  то будет использовано значение этого параметра
+ `-rt <n>` — время отдыха по умолчанию (указывается в количествах итераций):
  если время отдыха после определенного горячего временного промежутка не будет явно указано,
  то будет использовано значение этого параметра
+ `-si <n> <f>` — размер горячих данных из `n-ого` подмножества
  в соотношении ко всему множеству ключей
+ `-pi <n> <f>` — вероятность обращения к горячим данным из `n-ого` подмножества
  в соотношении ко всему множеству ключей
+ `-hti <n1> <n2>` — время работы с горячими данными из `n1-ого` подмножества
+ `-rti <n1> <n2>` — время отдыха после работы с горячими данными из `n1-ого` подмножества

##### Дополнительные параметры:
+ `-non-shuffle` — включения режима без перемешивания ключей
+ `-sbi` <n> <f> — левая граница горячих данных из `n-ого` подмножества
  в соотношении ко всему множеству ключей (работает лишь при включенном режиме `non-shuffle`)

#### Creakers and wave

+ `-gs <f>` || `-cs <f>` — размер подмножества старичков
  в соотношении ко всему множеству ключей
+ `-gp <f>` || `-cp <f>` — вероятность чтения из множества старичков
+ `-ws <f>` — размер волны в соотношении ко всему множеству ключей
+ `-g-age <n>` || `-c-age <n>` — возраст старичков.
  Перед началом тестирования, будет произведено `n` запросов чтения
  из множества старичков
+ `-g-dist <dist_type>` || `-c-dist <dist_type>` — распределение ключей
  для множества старичков.
  (Пока доступно только равномерное распределение)
+ `-w-dist <dist_type>` — распределение ключей
  для множества волны. (Пока доступно только распределение Ципфа)


### Распределения

+ `-dist-zipf <d>` — распределение Ципфа с параметром `d`
+ `-dist-uniform` — равномерное распределение
+ `-dist-skewed-uniform ...` — скошенное распределение

